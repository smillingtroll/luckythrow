<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duck Crash - TON Game</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary-green: #00ff88;
            --dark-green: #006633;
            --lava-red: #ff4400;
            --lava-orange: #ff8800;
            --dark-bg: #0a0a0a;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 480px;
            margin: 0 auto;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            padding: 12px 16px;
            background: rgba(10, 10, 10, 0.95);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
        }

        .balance-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 255, 136, 0.1);
            padding: 6px 12px;
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 136, 0.2);
            cursor: pointer;
        }

        #balance {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-green);
        }

        .wallet-icon {
            font-size: 18px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* –õ–æ–±–±–∏ –∏–≥—Ä */
        .games-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 32px;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-green);
        }

        .game-card-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .game-card-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-green);
            margin-bottom: 8px;
        }

        /* –ò–≥—Ä–∞ –ö–†–ê–® */
        .crash-visual {
            position: relative;
            height: 200px;
            background: linear-gradient(to bottom, rgba(5, 5, 5, 0.9), rgba(255, 68, 0, 0.1));
            border-radius: 24px;
            margin: 20px 0;
            border: 2px solid rgba(255, 68, 0, 0.2);
            overflow: hidden;
        }

        .lava-background {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to top, var(--lava-red), var(--lava-orange));
        }

        .duck-container {
            position: absolute;
            left: 20%;
            bottom: 30px;
            transition: all 0.05s linear;
        }

        .duck {
            position: relative;
        }

        .duck-body {
            font-size: 40px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .multiplier-display {
            text-align: center;
            margin: 20px 0;
        }

        .multiplier-value {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-green), var(--lava-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }

        .crash-controls {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-buttons {
            display: flex;
            gap: 12px;
            margin: 20px 0;
        }

        .control-btn {
            flex: 1;
            padding: 20px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .bet-btn {
            background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
            color: black;
        }

        .cashout-btn {
            background: linear-gradient(135deg, var(--lava-orange), var(--lava-red));
            color: white;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(5, 5, 5, 0.95);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: rgba(10, 10, 10, 0.95);
            border-radius: 24px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h3 {
            font-size: 20px;
            color: var(--primary-green);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* TON Connect –∫–Ω–æ–ø–∫–∞ */
        #ton-connect-button {
            width: 100%;
            margin: 20px 0;
        }

        .wallet-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--primary-green);
            border-radius: 12px;
            padding: 16px 24px;
            color: white;
            font-size: 14px;
            z-index: 10000;
            display: none;
            max-width: 90%;
        }

        .notification.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translate(-50%, 20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- –®–∞–ø–∫–∞ -->
        <header class="header">
            <div class="balance-container" onclick="showWalletModal()">
                <span class="wallet-icon">üëõ</span>
                <span id="balance">0.00</span>
                <span class="currency">TON</span>
            </div>
            <div class="user-info-container">
                <div class="username" id="username">–ò–≥—Ä–æ–∫</div>
                <div class="user-id" id="user-id"></div>
            </div>
        </header>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ—à–µ–ª—å–∫–∞ -->
        <div id="wallet-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>TON –ö–æ—à–µ–ª–µ–∫</h3>
                    <button class="close-btn" onclick="closeWalletModal()">√ó</button>
                </div>
                <div class="wallet-info">
                    <div id="ton-connect-button"></div>
                    <div id="wallet-connected" class="hidden">
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div style="width: 8px; height: 8px; border-radius: 50%; background: #00ff88;"></div>
                                <span>–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω</span>
                            </div>
                            <div style="font-family: monospace; font-size: 12px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; word-break: break-all;"
                                 id="wallet-address"></div>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            <button class="control-btn bet-btn" onclick="openDepositModal()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                            <button class="control-btn cashout-btn" onclick="openWithdrawModal()">–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ–ø–æ–∑–∏—Ç–∞ -->
        <div id="deposit-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h3>
                    <button class="close-btn" onclick="closeDepositModal()">√ó</button>
                </div>
                <div>
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        –û—Ç–ø—Ä–∞–≤—å—Ç–µ TON –Ω–∞ –∞–¥—Ä–µ—Å:
                    </p>
                    <div style="font-family: monospace; font-size: 12px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; word-break: break-all; margin-bottom: 20px;"
                         id="deposit-address">UQAthS8QDwBDsbohkCxqfL22NS4NrtV9QMC1jBj78bb-4pVe</div>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">
                        –ú–∏–Ω–∏–º—É–º: 1 TON<br>
                        –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–µ—Ç–∏
                    </p>
                    <button class="control-btn bet-btn" onclick="copyDepositAddress()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å</button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–≤–æ–¥–∞ -->
        <div id="withdraw-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h3>
                    <button class="close-btn" onclick="closeWithdrawModal()">√ó</button>
                </div>
                <div>
                    <input type="number" id="withdraw-amount" 
                           style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; margin-bottom: 12px;"
                           placeholder="–°—É–º–º–∞ –≤ TON" value="1" min="1" step="0.1">
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">
                        –î–æ—Å—Ç—É–ø–Ω–æ: <span id="available-balance">0</span> TON<br>
                        –ú–∏–Ω. –≤—ã–≤–æ–¥: 1 TON
                    </p>
                    <button class="control-btn bet-btn" onclick="requestWithdrawal()">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–≤–æ–¥</button>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="content">
            <!-- –õ–æ–±–±–∏ –∏–≥—Ä -->
            <div id="games-section" class="section active">
                <div style="text-align: center; margin-bottom: 32px;">
                    <h1 style="font-size: 32px; background: linear-gradient(135deg, var(--primary-green), var(--lava-orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
                        ü¶Ü DUCK CRASH
                    </h1>
                    <p style="color: var(--text-secondary);">–£—Ç–∫–∞ –Ω–∞ –ª–∞–≤–µ - –ª–æ–≤–∏ –º–æ–º–µ–Ω—Ç!</p>
                </div>
                
                <div class="games-grid">
                    <div class="game-card" onclick="showCrashGame()">
                        <div class="game-card-icon">ü¶Ü</div>
                        <div class="game-card-name">DUCK CRASH</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">–£—Ç–∫–∞ –Ω–∞ –ª–∞–≤–µ - –ª–æ–≤–∏ –º–æ–º–µ–Ω—Ç!</div>
                    </div>
                </div>
            </div>

            <!-- –ò–≥—Ä–∞ –ö–†–ê–® -->
            <div id="crash-section" class="section">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <button style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; border-radius: 12px; cursor: pointer;"
                            onclick="showGamesSection()">‚Üê –ù–∞–∑–∞–¥</button>
                    <h2 style="color: var(--primary-green);">ü¶Ü DUCK CRASH</h2>
                    <div style="background: linear-gradient(135deg, var(--primary-green), var(--dark-green)); padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                        –û–Ω–ª–∞–π–Ω: <span id="online-count">0</span>
                    </div>
                </div>

                <div class="crash-game-container">
                    <div class="crash-visual">
                        <div class="lava-background"></div>
                        <div class="duck-container" id="duck-container">
                            <div class="duck" id="duck">
                                <div class="duck-body">ü¶Ü</div>
                            </div>
                        </div>
                    </div>

                    <div class="multiplier-display">
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">–ú–£–õ–¨–¢–ò–ü–õ–ò–ö–ê–¢–û–†</div>
                        <div class="multiplier-value" id="current-multiplier">1.00x</div>
                        <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, var(--primary-green), var(--lava-orange)); width: 0%; transition: width 0.1s;" id="multiplier-progress"></div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.05); border-radius: 16px; padding: 16px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; text-align: center;">–ò–°–¢–û–†–ò–Ø –ò–ì–†</div>
                        <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px;" id="multiplier-history">
                            <div style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(0,255,136,0.1); color: var(--primary-green); border: 1px solid rgba(0,255,136,0.3);">2.15x</div>
                            <div style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(255,68,0,0.1); color: var(--lava-red); border: 1px solid rgba(255,68,0,0.3);">1.08x</div>
                            <div style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(0,255,136,0.1); color: var(--primary-green); border: 1px solid rgba(0,255,136,0.3);">4.78x</div>
                            <div style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(0,255,136,0.1); color: var(--primary-green); border: 1px solid rgba(0,255,136,0.3);">1.34x</div>
                        </div>
                    </div>
                </div>

                <div class="crash-controls">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary);">–°—Ç–∞–≤–∫–∞:</div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--primary-green);" id="current-bet">0 TON</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary);">–í—ã–∏–≥—Ä—ã—à:</div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--lava-orange);" id="potential-win-amount">0 TON</div>
                        </div>
                    </div>

                    <div class="control-buttons">
                        <button id="place-bet-btn" class="control-btn bet-btn" onclick="placeCrashBet()">
                            <div style="font-size: 16px;">–ü–û–°–¢–ê–í–ò–¢–¨</div>
                            <div style="font-size: 12px; opacity: 0.9;" id="bet-amount-display">0.1 TON</div>
                        </button>
                        <button id="cashout-btn" class="control-btn cashout-btn hidden" onclick="cashOut()">
                            <div style="font-size: 16px;">–ó–ê–ë–†–ê–¢–¨</div>
                            <div style="font-size: 12px; opacity: 0.9;" id="cashout-multiplier">1.00x</div>
                        </button>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <input type="range" id="crash-bet-slider" min="0.1" max="100" step="0.1" value="0.1" 
                               style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-bottom: 8px;"
                               oninput="updateCrashBetAmount()">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary);">
                            <span>0.1</span>
                            <span>50</span>
                            <span>100</span>
                        </div>
                    </div>

                    <div style="margin-top: 24px;">
                        <div style="font-size: 14px; color: var(--text-secondary); text-align: center; margin-bottom: 12px;">–®–ê–ù–°–´ –ù–ê –ü–û–ë–ï–î–£</div>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 8px; text-align: center; cursor: pointer;" onclick="setTargetMultiplier(1.34)">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary-green);">1.34x</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">50%</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 8px; text-align: center; cursor: pointer;" onclick="setTargetMultiplier(1.59)">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary-green);">1.59x</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">25%</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 8px; text-align: center; cursor: pointer;" onclick="setTargetMultiplier(6.14)">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary-green);">6.14x</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">20%</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 8px; text-align: center; cursor: pointer;" onclick="setTargetMultiplier(15)">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary-green);">15x</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">4.9%</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 8px; text-align: center; cursor: pointer;" onclick="setTargetMultiplier(150)">
                                <div style="font-size: 12px; font-weight: 600; color: var(--primary-green);">150x</div>
                                <div style="font-size: 10px; color: var(--text-secondary);">0.1%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div id="notification" class="notification">
        <span id="notification-text"></span>
    </div>

    <script>
        // === –ö–û–ù–°–¢–ê–ù–¢–´ ===
        const GAME_WALLET_ADDRESS = "UQAthS8QDwBDsbohkCxqfL22NS4NrtV9QMC1jBj78bb-4pVe";
        const API_BASE_URL = "https://your-api-server.com/api"; // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® API
        const TELEGRAM_BOT_TOKEN = "YOUR_BOT_TOKEN"; // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –¢–û–ö–ï–ù

        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        let appData = {
            userId: null,
            balance: 0,
            walletConnected: false,
            walletAddress: null,
            crashGame: {
                betAmount: 0.1,
                currentMultiplier: 1.00,
                gameActive: false,
                betPlaced: false,
                crashPoint: null,
                interval: null,
                duckPosition: 0
            },
            telegramUser: null
        };

        let tonConnectUI = null;
        let tg = window.Telegram?.WebApp;
        let balanceCheckInterval = null;

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        document.addEventListener('DOMContentLoaded', async function() {
            await initApp();
            initTONConnect();
            startBalanceChecker();
        });

        async function initApp() {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
                if (tg) {
                    tg.ready();
                    tg.expand();
                    
                    appData.telegramUser = tg.initDataUnsafe?.user;
                    if (appData.telegramUser) {
                        appData.userId = appData.telegramUser.id.toString();
                        document.getElementById('username').textContent = 
                            appData.telegramUser.username || appData.telegramUser.first_name || '–ò–≥—Ä–æ–∫';
                        
                        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        await registerUser();
                    }
                } else {
                    // –î–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
                    appData.userId = 'web_' + Math.random().toString(36).substr(2, 9);
                }

                // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
                await loadBalance();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                updateUI();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', 'error');
            }
        }

        // === API –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï ===
        async function registerUser() {
            try {
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: appData.userId,
                        telegramData: appData.telegramUser,
                        walletAddress: appData.walletAddress
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    appData.balance = data.balance || 0;
                    updateUI();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
            }
        }

        async function loadBalance() {
            try {
                if (!appData.userId) return;
                
                const response = await fetch(`${API_BASE_URL}/balance/${appData.userId}`);
                const data = await response.json();
                
                if (data.success) {
                    appData.balance = data.balance;
                    updateUI();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
            }
        }

        async function updateBalance(amount) {
            try {
                const response = await fetch(`${API_BASE_URL}/update-balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: appData.userId,
                        amount: amount,
                        type: 'game_result'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    appData.balance = data.newBalance;
                    updateUI();
                    return true;
                }
                return false;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:', error);
                return false;
            }
        }

        async function checkDeposits() {
            try {
                if (!appData.walletAddress) return;
                
                const response = await fetch(`${API_BASE_URL}/check-deposits/${appData.walletAddress}`);
                const data = await response.json();
                
                if (data.success && data.deposits && data.deposits.length > 0) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã
                    await loadBalance();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤:', error);
            }
        }

        async function requestWithdrawal() {
            try {
                const amountInput = document.getElementById('withdraw-amount');
                const amount = parseFloat(amountInput.value);
                
                if (isNaN(amount) || amount < 1) {
                    showNotification('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ 1 TON', 'error');
                    return;
                }
                
                if (amount > appData.balance) {
                    showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'error');
                    return;
                }
                
                if (!appData.walletAddress) {
                    showNotification('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/withdraw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: appData.userId,
                        amount: amount,
                        walletAddress: appData.walletAddress
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –°—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ—Å—Ç—É–ø—è—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤', 'success');
                    closeWithdrawModal();
                    await loadBalance();
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'error');
            }
        }

        // === TON CONNECT ===
        function initTONConnect() {
            try {
                const manifest = {
                    url: window.location.href,
                    name: 'Duck Crash Game',
                    iconUrl: 'https://raw.githubusercontent.com/ton-community/tutorials/main/03-client/test-dapp/icon.png'
                };

                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifest: manifest,
                    buttonRootId: 'ton-connect-button'
                });

                tonConnectUI.onStatusChange(async (wallet) => {
                    if (wallet) {
                        appData.walletConnected = true;
                        appData.walletAddress = wallet.account.address;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                        await saveWalletAddress();
                        
                        document.getElementById('wallet-connected').classList.remove('hidden');
                        document.getElementById('wallet-address').textContent = 
                            `${wallet.account.address.substring(0, 6)}...${wallet.account.address.substring(wallet.account.address.length - 4)}`;
                        
                        showNotification('‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω!', 'success');
                        
                        // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–µ–ø–æ–∑–∏—Ç–æ–≤
                        startBalanceChecker();
                    } else {
                        appData.walletConnected = false;
                        appData.walletAddress = null;
                        document.getElementById('wallet-connected').classList.add('hidden');
                        showNotification('–ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
                    }
                });

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ TON Connect:', error);
            }
        }

        async function saveWalletAddress() {
            try {
                if (!appData.userId || !appData.walletAddress) return;
                
                await fetch(`${API_BASE_URL}/save-wallet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: appData.userId,
                        walletAddress: appData.walletAddress
                    })
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', error);
            }
        }

        function startBalanceChecker() {
            if (balanceCheckInterval) {
                clearInterval(balanceCheckInterval);
            }
            
            balanceCheckInterval = setInterval(async () => {
                if (appData.walletConnected) {
                    await checkDeposits();
                }
            }, 30000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        }

        // === –ò–ì–†–ê –ö–†–ê–® ===
        function updateCrashBetAmount() {
            const slider = document.getElementById('crash-bet-slider');
            const amount = parseFloat(slider.value);
            
            if (!isNaN(amount) && amount >= 0.1) {
                appData.crashGame.betAmount = amount;
                updateUI();
            }
        }

        function setTargetMultiplier(multiplier) {
            showNotification(`–¶–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${multiplier}x`, 'info');
        }

        async function placeCrashBet() {
            if (appData.crashGame.betAmount > appData.balance) {
                showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 'error');
                return;
            }
            
            if (appData.crashGame.gameActive) {
                showNotification('–ò–≥—Ä–∞ —É–∂–µ –∏–¥–µ—Ç!', 'error');
                return;
            }
            
            // –°–ø–∏—à–µ–º —Å—Ç–∞–≤–∫—É —á–µ—Ä–µ–∑ API
            const success = await updateBalance(-appData.crashGame.betAmount);
            if (!success) {
                showNotification('–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤', 'error');
                return;
            }
            
            appData.crashGame.gameActive = true;
            appData.crashGame.betPlaced = true;
            appData.crashGame.currentMultiplier = 1.00;
            appData.crashGame.duckPosition = 0;
            
            generateCrashPoint();
            startCrashGame();
            updateUI();
            showNotification('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!', 'info');
        }

        function generateCrashPoint() {
            const rand = Math.random() * 100;
            let crashPoint;
            
            if (rand < 50) {
                crashPoint = 1 + Math.random() * 0.34; // 1.00x - 1.34x (50%)
            } else if (rand < 75) {
                crashPoint = 1 + Math.random() * 0.59; // 1.00x - 1.59x (25%)
            } else if (rand < 95) {
                crashPoint = 1 + Math.random() * 5.14; // 1.00x - 6.14x (20%)
            } else if (rand < 99.9) {
                crashPoint = 1 + Math.random() * 14; // 1.00x - 15x (4.9%)
            } else {
                crashPoint = 1 + Math.random() * 149; // 1.00x - 150x (0.1%)
            }
            
            appData.crashGame.crashPoint = parseFloat(crashPoint.toFixed(2));
        }

        function startCrashGame() {
            const duckContainer = document.getElementById('duck-container');
            const progressBar = document.getElementById('multiplier-progress');
            
            if (appData.crashGame.interval) {
                clearInterval(appData.crashGame.interval);
            }
            
            appData.crashGame.interval = setInterval(() => {
                if (!appData.crashGame.gameActive) return;
                
                appData.crashGame.currentMultiplier += 0.01;
                
                appData.crashGame.duckPosition += 0.5;
                if (duckContainer) {
                    duckContainer.style.left = `${20 + appData.crashGame.duckPosition}%`;
                }
                
                if (progressBar && appData.crashGame.crashPoint) {
                    const progress = Math.min((appData.crashGame.currentMultiplier - 1) / (appData.crashGame.crashPoint - 1) * 100, 100);
                    progressBar.style.width = `${progress}%`;
                }
                
                if (appData.crashGame.currentMultiplier >= appData.crashGame.crashPoint) {
                    crashDuck();
                }
                
                updateUI();
            }, 100);
        }

        async function cashOut() {
            if (!appData.crashGame.gameActive || !appData.crashGame.betPlaced) return;
            
            clearInterval(appData.crashGame.interval);
            
            const winAmount = appData.crashGame.betAmount * appData.crashGame.currentMultiplier;
            
            // –ó–∞—á–∏—Å–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à —á–µ—Ä–µ–∑ API
            const success = await updateBalance(winAmount);
            if (success) {
                showNotification(`üéâ –í—ã –∑–∞–±—Ä–∞–ª–∏ ${winAmount.toFixed(2)} TON!`, 'success');
                addToHistory(appData.crashGame.currentMultiplier, true);
            }
            
            resetCrashGame();
            updateUI();
        }

        async function crashDuck() {
            clearInterval(appData.crashGame.interval);
            
            const duck = document.getElementById('duck');
            
            if (duck) {
                duck.classList.add('crashed');
                
                setTimeout(() => {
                    duck.classList.remove('crashed');
                    
                    showNotification(`üí• –ö—Ä–∞—à –Ω–∞ ${appData.crashGame.currentMultiplier.toFixed(2)}x!`, 'error');
                    addToHistory(appData.crashGame.currentMultiplier, false);
                    
                    resetCrashGame();
                    updateUI();
                }, 1000);
            } else {
                resetCrashGame();
            }
        }

        function addToHistory(multiplier, isWin) {
            const historyList = document.getElementById('multiplier-history');
            if (!historyList) return;
            
            const historyItem = document.createElement('div');
            historyItem.style.cssText = 'padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; min-width: 60px; text-align: center;';
            historyItem.style.background = isWin ? 'rgba(0,255,136,0.1)' : 'rgba(255,68,0,0.1)';
            historyItem.style.color = isWin ? 'var(--primary-green)' : 'var(--lava-red)';
            historyItem.style.border = isWin ? '1px solid rgba(0,255,136,0.3)' : '1px solid rgba(255,68,0,0.3)';
            historyItem.textContent = `${multiplier.toFixed(2)}x`;
            
            historyList.insertBefore(historyItem, historyList.firstChild);
            
            if (historyList.children.length > 4) {
                historyList.removeChild(historyList.lastChild);
            }
        }

        function resetCrashGame() {
            appData.crashGame.gameActive = false;
            appData.crashGame.betPlaced = false;
            appData.crashGame.currentMultiplier = 1.00;
            appData.crashGame.crashPoint = null;
            appData.crashGame.duckPosition = 0;
            
            const duckContainer = document.getElementById('duck-container');
            const progressBar = document.getElementById('multiplier-progress');
            
            if (duckContainer) duckContainer.style.left = '20%';
            if (progressBar) progressBar.style.width = '0%';
            
            if (appData.crashGame.interval) {
                clearInterval(appData.crashGame.interval);
                appData.crashGame.interval = null;
            }
            
            updateUI();
        }

        // === UI –§–£–ù–ö–¶–ò–ò ===
        function updateUI() {
            // –ë–∞–ª–∞–Ω—Å
            document.getElementById('balance').textContent = appData.balance.toFixed(2);
            document.getElementById('available-balance').textContent = appData.balance.toFixed(2);
            
            // –ò–≥—Ä–∞ –∫—Ä–∞—à
            document.getElementById('current-multiplier').textContent = `${appData.crashGame.currentMultiplier.toFixed(2)}x`;
            document.getElementById('cashout-multiplier').textContent = `${appData.crashGame.currentMultiplier.toFixed(2)}x`;
            document.getElementById('current-bet').textContent = `${appData.crashGame.betAmount.toFixed(2)} TON`;
            document.getElementById('bet-amount-display').textContent = `${appData.crashGame.betAmount.toFixed(1)} TON`;
            
            const winAmount = appData.crashGame.betAmount * appData.crashGame.currentMultiplier;
            document.getElementById('potential-win-amount').textContent = `${winAmount.toFixed(2)} TON`;
            
            // –ö–Ω–æ–ø–∫–∏
            const placeBetBtn = document.getElementById('place-bet-btn');
            const cashoutBtn = document.getElementById('cashout-btn');
            
            if (appData.crashGame.gameActive && appData.crashGame.betPlaced) {
                placeBetBtn.classList.add('hidden');
                cashoutBtn.classList.remove('hidden');
            } else {
                placeBetBtn.classList.remove('hidden');
                cashoutBtn.classList.add('hidden');
            }
            
            // –°–ª–∞–π–¥–µ—Ä
            document.getElementById('crash-bet-slider').value = appData.crashGame.betAmount;
        }

        function showWalletModal() {
            document.getElementById('wallet-modal').classList.add('active');
        }

        function closeWalletModal() {
            document.getElementById('wallet-modal').classList.remove('active');
        }

        function openDepositModal() {
            if (!appData.walletConnected) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫', 'error');
                return;
            }
            closeWalletModal();
            document.getElementById('deposit-modal').classList.add('active');
        }

        function closeDepositModal() {
            document.getElementById('deposit-modal').classList.remove('active');
        }

        function openWithdrawModal() {
            if (!appData.walletConnected) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫', 'error');
                return;
            }
            closeWalletModal();
            document.getElementById('withdraw-modal').classList.add('active');
        }

        function closeWithdrawModal() {
            document.getElementById('withdraw-modal').classList.remove('active');
        }

        function copyDepositAddress() {
            const address = GAME_WALLET_ADDRESS;
            navigator.clipboard.writeText(address).then(() => {
                showNotification('‚úÖ –ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!', 'success');
            });
        }

        function showGamesSection() {
            document.getElementById('games-section').classList.add('active');
            document.getElementById('crash-section').classList.remove('active');
        }

        function showCrashGame() {
            document.getElementById('games-section').classList.remove('active');
            document.getElementById('crash-section').classList.add('active');
        }

        function showNotification(text, type) {
            const notification = document.getElementById('notification');
            const textElement = document.getElementById('notification-text');
            
            if (!notification || !textElement) return;
            
            textElement.textContent = text;
            notification.className = `notification ${type}`;
            notification.classList.add('active');
            
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
    </script>
</body>
</html>
